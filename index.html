<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>آزمونجو Pro | پلتفرم آزمون آنلاین</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --light: #f8f9fa;
            --dark: #212529;
            --admin: #7209b7;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Vazirmatn', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .hidden {
            display: none !important;
        }
        
        .active {
            display: block !important;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .subscription-plan {
            border: 2px solid #ddd;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
            margin: 15px 0;
        }
        
        .subscription-plan:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(67, 97, 238, 0.2);
        }
        
        .plan-price {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin: 15px 0;
        }
        
        .plan-features {
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }
        
        .plan-features li {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .user-avatar {
            width: 60px;
            height: 60px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--success);
            color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        .notification.error {
            background: var(--danger);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- صفحه ورود -->
        <div id="loginPage" class="card active">
            <div style="text-align: center; margin-bottom: 30px;">
                <h1 style="color: var(--primary); font-size: 2.5rem;">
                    <i class="fas fa-graduation-cap"></i> آزمونجو Pro
                </h1>
                <p style="color: #666;">پلتفرم حرفه‌ای آزمون آنلاین</p>
            </div>
            
            <div id="loginForm">
                <h2 style="margin-bottom: 25px;">ورود به سیستم</h2>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">نام کاربری:</label>
                    <input type="text" id="username" placeholder="testuser">
                </div>
                
                <div style="margin-bottom: 30px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">رمز عبور:</label>
                    <input type="password" id="password" placeholder="123456">
                </div>
                
                <button class="btn btn-primary" onclick="login()" style="width: 100%; padding: 15px; font-size: 18px;">
                    <i class="fas fa-sign-in-alt"></i> ورود به سیستم
                </button>
                
                <div style="text-align: center; margin-top: 25px;">
                    <button class="btn btn-success" onclick="useDemoAccount('teacher')" style="width: 100%; margin-bottom: 10px;">
                        <i class="fas fa-chalkboard-teacher"></i> ورود به عنوان معلم
                    </button>
                    
                    <button class="btn" onclick="showRegister()" style="width: 100%; background: #f8f9fa;">
                        <i class="fas fa-user-plus"></i> ثبت‌نام کاربر جدید
                    </button>
                </div>
            </div>
            
            <div id="registerForm" class="hidden">
                <h2 style="margin-bottom: 25px;">ثبت‌نام کاربر جدید</h2>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">نام کامل:</label>
                    <input type="text" id="regName" placeholder="نام و نام خانوادگی">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">نام کاربری:</label>
                    <input type="text" id="regUsername" placeholder="حداقل ۴ حرف">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">رمز عبور:</label>
                    <input type="password" id="regPassword" placeholder="حداقل ۶ حرف">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">نقش:</label>
                    <select id="regRole" style="padding: 12px;">
                        <option value="teacher">معلم</option>
                        <option value="student">دانش‌آموز</option>
                    </select>
                </div>
                
                <button class="btn btn-primary" onclick="register()" style="width: 100%; padding: 15px;">
                    <i class="fas fa-user-plus"></i> ثبت‌نام
                </button>
                
                <button class="btn" onclick="showLogin()" style="width: 100%; margin-top: 10px; background: #f8f9fa;">
                    بازگشت به صفحه ورود
                </button>
            </div>
        </div>
        
        <!-- صفحه اصلی -->
        <div id="mainPage" class="hidden">
            <!-- هدر -->
            <div class="card" style="display: flex; justify-content: space-between; align-items: center; padding: 20px;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div>
                        <h3 id="userName">کاربر</h3>
                        <p style="color: #666;" id="userRole">نقش کاربر</p>
                    </div>
                </div>
                
                <div>
                    <button class="btn btn-primary" onclick="showSection('dashboard')">
                        <i class="fas fa-home"></i> پیشخوان
                    </button>
                    <button class="btn btn-danger" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> خروج
                    </button>
                </div>
            </div>
            
            <!-- محتوای اصلی -->
            <div id="contentArea">
                <!-- پیشخوان -->
                <div id="dashboardSection" class="card active">
                    <h2 style="color: var(--primary); margin-bottom: 25px;">
                        <i class="fas fa-tachometer-alt"></i> پیشخوان
                    </h2>
                    
                    <!-- وضعیت اشتراک -->
                    <div id="subscriptionStatus" style="margin-bottom: 30px;"></div>
                    
                    <!-- پلن‌های اشتراک -->
                    <h3 style="margin: 30px 0 20px 0;">پلن‌های اشتراک</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <!-- پلن ماهانه -->
                        <div class="subscription-plan">
                            <h3>اشتراک ماهانه</h3>
                            <div class="plan-price">۵۰,۰۰۰ تومان</div>
                            <p>مناسب برای معلمان مستقل</p>
                            <ul class="plan-features">
                                <li>✅ ایجاد ۱۰ آزمون در ماه</li>
                                <li>✅ تا ۱۰۰ دانش‌آموز</li>
                                <li>✅ کارنامه پیشرفته</li>
                                <li>✅ پشتیبانی ایمیل</li>
                            </ul>
                            <button class="btn btn-primary" onclick="buySubscription('monthly')" style="width: 100%;">
                                <i class="fas fa-shopping-cart"></i> خرید اشتراک
                            </button>
                        </div>
                        
                        <!-- پلن سه‌ماهه -->
                        <div class="subscription-plan" style="border-color: var(--success);">
                            <div style="background: var(--success); color: white; padding: 5px 15px; border-radius: 20px; display: inline-block; margin-bottom: 15px;">
                                محبوب
                            </div>
                            <h3>اشتراک سه‌ماهه</h3>
                            <div class="plan-price">۱۳۵,۰۰۰ تومان</div>
                            <p style="color: var(--success); font-weight: bold;">صرفه‌جویی ۱۵,۰۰۰ تومان</p>
                            <ul class="plan-features">
                                <li>✅ ایجاد ۴۰ آزمون در سه ماه</li>
                                <li>✅ تا ۵۰۰ دانش‌آموز</li>
                                <li>✅ کارنامه پیشرفته + نمودار</li>
                                <li>✅ پشتیبانی تلفنی</li>
                            </ul>
                            <button class="btn btn-success" onclick="buySubscription('quarterly')" style="width: 100%;">
                                <i class="fas fa-crown"></i> خرید اشتراک
                            </button>
                        </div>
                        
                        <!-- پلن سالانه -->
                        <div class="subscription-plan" style="border-color: var(--admin);">
                            <div style="background: var(--admin); color: white; padding: 5px 15px; border-radius: 20px; display: inline-block; margin-bottom: 15px;">
                                اقتصادی
                            </div>
                            <h3>اشتراک سالانه</h3>
                            <div class="plan-price">۴۸۰,۰۰۰ تومان</div>
                            <p style="color: var(--admin); font-weight: bold;">صرفه‌جویی ۱۲۰,۰۰۰ تومان</p>
                            <ul class="plan-features">
                                <li>✅ ایجاد ۲۰۰ آزمون در سال</li>
                                <li>✅ دانش‌آموزان نامحدود</li>
                                <li>✅ تمامی امکانات پیشرفته</li>
                                <li>✅ پشتیبانی VIP</li>
                            </ul>
                            <button class="btn" onclick="buySubscription('yearly')" style="width: 100%; background: var(--admin); color: white;">
                                <i class="fas fa-gem"></i> خرید اشتراک
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== سیستم پرداخت PayPing ====================
        class PayPingPayment {
            constructor() {
                this.token = '2267EBA9EDC4E8C2FFB7DBD9FD4A47D7A60874638FAB598A8C492439C5AC066B-1';
                this.baseURL = 'https://api.payping.ir/v2';
                this.callbackUrl = window.location.origin + '/payment-callback.html';
            }

            // ایجاد پرداخت جدید
            async createPayment(amount, description, userInfo) {
                try {
                    console.log('در حال ایجاد پرداخت با PayPing...');
                    console.log('مبلغ:', amount * 1000, 'ریال');
                    console.log('توکن:', this.token.substring(0, 20) + '...');
                    
                    const response = await fetch(`${this.baseURL}/pay`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.token}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            amount: amount * 1000, // تبدیل به ریال
                            returnUrl: this.callbackUrl,
                            description: description,
                            clientRefId: `user_${userInfo.id || userInfo.username}_${Date.now()}`,
                            payerIdentity: userInfo.phone || userInfo.email || userInfo.username,
                            payerName: userInfo.name
                        })
                    });

                    const data = await response.json();
                    console.log('پاسخ PayPing:', data);
                    
                    if (data.code) {
                        return {
                            success: true,
                            code: data.code,
                            paymentUrl: `https://api.payping.ir/v2/pay/gotoipg/${data.code}`
                        };
                    } else {
                        return {
                            success: false,
                            error: data.Message || 'خطا در ایجاد درگاه پرداخت'
                        };
                    }
                } catch (error) {
                    console.error('PayPing Error:', error);
                    return {
                        success: false,
                        error: 'خطا در ارتباط با سرویس پرداخت'
                    };
                }
            }

            // تایید پرداخت
            async verifyPayment(refId, amount) {
                try {
                    const response = await fetch(`${this.baseURL}/pay/verify`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.token}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            refId: refId,
                            amount: amount * 1000
                        })
                    });

                    const data = await response.json();
                    console.log('تایید پرداخت:', data);
                    
                    if (data.Success) {
                        return {
                            success: true,
                            cardNumber: data.cardNumber,
                            cardHashPan: data.cardHashPan
                        };
                    } else {
                        return {
                            success: false,
                            error: data.Message || 'خطا در تایید پرداخت'
                        };
                    }
                } catch (error) {
                    console.error('PayPing Verify Error:', error);
                    return {
                        success: false,
                        error: 'خطا در تایید پرداخت'
                    };
                }
            }
        }

        // ==================== سیستم اشتراک ====================
        class SubscriptionSystem {
            constructor() {
                this.payment = new PayPingPayment();
                this.plans = {
                    monthly: {
                        id: 'monthly',
                        name: 'اشتراک ماهانه',
                        price: 50000,
                        duration: 30,
                        features: ['۱۰ آزمون در ماه', '۱۰۰ دانش‌آموز', 'کارنامه پیشرفته']
                    },
                    quarterly: {
                        id: 'quarterly',
                        name: 'اشتراک سه ماهه',
                        price: 135000,
                        duration: 90,
                        features: ['۴۰ آزمون', '۵۰۰ دانش‌آموز', 'نمودار پیشرفت']
                    },
                    yearly: {
                        id: 'yearly',
                        name: 'اشتراک سالانه',
                        price: 480000,
                        duration: 365,
                        features: ['آزمون نامحدود', 'دانش‌آموز نامحدود', 'پشتیبانی VIP']
                    }
                };
            }

            // خرید اشتراک
            async purchaseSubscription(userId, planId) {
                const plan = this.plans[planId];
                if (!plan) {
                    showNotification('پلن انتخابی معتبر نیست', 'error');
                    return;
                }

                // دریافت اطلاعات کاربر
                const users = getUsers();
                const user = users.find(u => u.id === userId || u.username === userId);
                
                if (!user) {
                    showNotification('کاربر یافت نشد', 'error');
                    return;
                }

                // ایجاد تراکنش
                const paymentResult = await this.payment.createPayment(
                    plan.price,
                    `خرید ${plan.name} - آزمونجو`,
                    {
                        name: user.name,
                        phone: user.phone || '',
                        email: user.email || '',
                        id: user.id,
                        username: user.username
                    }
                );

                if (paymentResult.success) {
                    // ذخیره اطلاعات تراکنش
                    this.saveTransaction({
                        userId: userId,
                        planId: planId,
                        amount: plan.price,
                        paypingCode: paymentResult.code,
                        status: 'pending',
                        createdAt: new Date().toISOString()
                    });

                    // هدایت به درگاه پرداخت
                    showNotification('در حال انتقال به درگاه پرداخت...');
                    setTimeout(() => {
                        window.location.href = paymentResult.paymentUrl;
                    }, 1000);
                } else {
                    showNotification(paymentResult.error, 'error');
                }
            }

            // ذخیره تراکنش
            saveTransaction(data) {
                let transactions = getTransactions();
                transactions.push(data);
                localStorage.setItem('azmoonjo_transactions', JSON.stringify(transactions));
            }

            // فعال‌سازی اشتراک
            activateSubscription(userId, planId) {
                const users = getUsers();
                const userIndex = users.findIndex(u => u.id === userId || u.username === userId);
                
                if (userIndex !== -1) {
                    const plan = this.plans[planId];
                    const expireDate = new Date();
                    expireDate.setDate(expireDate.getDate() + plan.duration);
                    
                    users[userIndex].subscription = {
                        planId: planId,
                        planName: plan.name,
                        startDate: new Date().toISOString(),
                        expireDate: expireDate.toISOString(),
                        active: true
                    };
                    
                    localStorage.setItem('azmoonjo_users', JSON.stringify(users));
                    return true;
                }
                return false;
            }

            // بررسی وضعیت اشتراک
            checkSubscription(userId) {
                const users = getUsers();
                const user = users.find(u => u.id === userId || u.username === userId);
                
                if (user && user.subscription) {
                    const now = new Date();
                    const expireDate = new Date(user.subscription.expireDate);
                    
                    if (now < expireDate && user.subscription.active) {
                        return {
                            active: true,
                            planName: user.subscription.planName,
                            expireDate: user.subscription.expireDate,
                            daysLeft: Math.ceil((expireDate - now) / (1000 * 60 * 60 * 24))
                        };
                    }
                }
                
                return { active: false };
            }
        }

        // ==================== سیستم اصلی ====================
        let currentUser = null;
        let subscriptionSystem = new SubscriptionSystem();

        // توابع کمکی
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type === 'error' ? 'error' : ''}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 3000);
        }

        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function getUsers() {
            return JSON.parse(localStorage.getItem('azmoonjo_users')) || [];
        }

        function getTransactions() {
            return JSON.parse(localStorage.getItem('azmoonjo_transactions')) || [];
        }

        // احراز هویت
        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!username || !password) {
                showNotification('لطفاً نام کاربری و رمز عبور را وارد کنید', 'error');
                return;
            }
            
            const users = getUsers();
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                showNotification(`خوش آمدید ${user.name}!`);
                
                // نمایش صفحه اصلی
                document.getElementById('loginPage').classList.remove('active');
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('mainPage').classList.remove('hidden');
                
                // به‌روزرسانی اطلاعات کاربر
                updateUserInfo();
                updateSubscriptionStatus();
            } else {
                showNotification('نام کاربری یا رمز عبور اشتباه است', 'error');
            }
        }

        function useDemoAccount(role) {
            let username, password;
            
            if (role === 'teacher') {
                username = 'teacher1';
                password = '123456';
            }
            
            document.getElementById('username').value = username;
            document.getElementById('password').value = password;
            login();
        }

        function register() {
            const name = document.getElementById('regName').value.trim();
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value.trim();
            const role = document.getElementById('regRole').value;
            
            if (!name || !username || !password) {
                showNotification('لطفاً تمام فیلدها را پر کنید', 'error');
                return;
            }
            
            if (username.length < 4) {
                showNotification('نام کاربری باید حداقل ۴ حرف باشد', 'error');
                return;
            }
            
            if (password.length < 6) {
                showNotification('رمز عبور باید حداقل ۶ حرف باشد', 'error');
                return;
            }
            
            const users = getUsers();
            
            if (users.find(u => u.username === username)) {
                showNotification('این نام کاربری قبلاً ثبت شده است', 'error');
                return;
            }
            
            const newUser = {
                id: Date.now(),
                name: name,
                username: username,
                password: password,
                role: role,
                date: new Date().toLocaleDateString('fa-IR')
            };
            
            users.push(newUser);
            localStorage.setItem('azmoonjo_users', JSON.stringify(users));
            
            showNotification('ثبت‌نام با موفقیت انجام شد! اکنون وارد شوید.');
            showLogin();
            
            // پاک کردن فرم
            document.getElementById('regName').value = '';
            document.getElementById('regUsername').value = '';
            document.getElementById('regPassword').value = '';
        }

        function logout() {
            currentUser = null;
            document.getElementById('mainPage').classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('loginPage').classList.add('active');
            showNotification('با موفقیت از سیستم خارج شدید');
        }

        function updateUserInfo() {
            if (!currentUser) return;
            
            document.getElementById('userName').textContent = currentUser.name;
            
            let roleText = '';
            let color = '';
            
            switch(currentUser.role) {
                case 'teacher':
                    roleText = 'معلم';
                    color = '#4361ee';
                    break;
                case 'student':
                    roleText = 'دانش‌آموز';
                    color = '#4cc9f0';
                    break;
            }
            
            document.getElementById('userRole').textContent = roleText;
            document.getElementById('userAvatar').style.background = color;
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);
        }

        function showSection(sectionId) {
            document.querySelectorAll('#contentArea > div').forEach(div => {
                div.classList.remove('active');
                div.classList.add('hidden');
            });
            
            const section = document.getElementById(sectionId + 'Section');
            if (section) {
                section.classList.remove('hidden');
                section.classList.add('active');
            }
        }

        // خرید اشتراک
        function buySubscription(planId) {
            if (!currentUser) {
                showNotification('لطفاً ابتدا وارد سیستم شوید', 'error');
                return;
            }
            
            subscriptionSystem.purchaseSubscription(currentUser.username, planId);
        }

        // به‌روزرسانی وضعیت اشتراک
        function updateSubscriptionStatus() {
            if (!currentUser) return;
            
            const status = subscriptionSystem.checkSubscription(currentUser.username);
            const statusElement = document.getElementById('subscriptionStatus');
            
            if (status.active) {
                statusElement.innerHTML = `
                    <div style="background: linear-gradient(135deg, #d4edda, #c3e6cb); color: #155724; padding: 20px; border-radius: 15px; border-right: 5px solid #28a745;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 2rem;">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div>
                                <h3 style="margin: 0;">اشتراک ${status.planName}</h3>
                                <p style="margin: 5px 0 0 0; font-size: 0.9rem;">
                                    <i class="far fa-calendar-check"></i>
                                    ${status.daysLeft} روز باقی مانده
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                statusElement.innerHTML = `
                    <div style="background: linear-gradient(135deg, #fff3cd, #ffeaa7); color: #856404; padding: 20px; border-radius: 15px; border-right: 5px solid #ffc107;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 2rem;">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div>
                                <h3 style="margin: 0;">اشتراک فعال ندارید</h3>
                                <p style="margin: 5px 0 0 0; font-size: 0.9rem;">
                                    برای دسترسی کامل به امکانات، یکی از پلن‌های زیر را انتخاب کنید
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // ==================== پردازش بازگشت از درگاه ====================
        function processPaymentCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const refId = urlParams.get('refid');
            const clientRefId = urlParams.get('clientrefid');
            
            if (code && refId) {
                // پردازش بازگشت از درگاه
                verifyPaymentFromCallback(code, refId, clientRefId);
            }
        }

        async function verifyPaymentFromCallback(code, refId, clientRefId) {
            // این تابع در صفحه callback.html فراخوانی می‌شود
            console.log('پرداخت بازگشت:', { code, refId, clientRefId });
            
            // استخراج اطلاعات از clientRefId
            const match = clientRefId.match(/user_(\w+)_(\d+)/);
            if (match) {
                const userId = match[1];
                const planId = 'monthly'; // در حالت واقعی از دیتابیس بخوانید
                
                // فعال‌سازی اشتراک
                if (subscriptionSystem.activateSubscription(userId, planId)) {
                    showNotification('اشتراک شما با موفقیت فعال شد!');
                    updateSubscriptionStatus();
                }
            }
        }

        // ==================== راه‌اندازی اولیه ====================
        window.onload = function() {
            // ایجاد کاربران نمونه
            if (getUsers().length === 0) {
                const sampleUsers = [
                    {
                        id: 1,
                        name: 'محمد رضایی',
                        username: 'teacher1',
                        password: '123456',
                        role: 'teacher',
                        date: '1402/10/01'
                    },
                    {
                        id: 2,
                        name: 'علی محمدی',
                        username: 'student1',
                        password: '123456',
                        role: 'student',
                        date: '1402/10/02'
                    }
                ];
                localStorage.setItem('azmoonjo_users', JSON.stringify(sampleUsers));
                showNotification('داده‌های نمونه بارگذاری شد');
            }
            
            // پردازش بازگشت از درگاه
            processPaymentCallback();
        };
    </script>
</body>
</html>
